{% extends "base.html" %}

{% block title %}Instagram Automation - Logs{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    Logs do Sistema
                </h2>
            </div>
            <div class="card-body">
                {% if log_files %}
                    <div class="row">
                        <div class="col-md-8">
                            <h5>
                                <i class="fas fa-list me-2"></i>
                                Arquivos de Log ({{ log_files|length }})
                            </h5>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-file me-1"></i>Arquivo</th>
                                            <th><i class="fas fa-calendar me-1"></i>Data</th>
                                            <th><i class="fas fa-cogs me-1"></i>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for log_file in log_files %}
                                        <tr>
                                            <td>
                                                <i class="fas fa-file-alt text-primary me-2"></i>
                                                <strong>{{ log_file }}</strong>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    {% if log_file.endswith('.log') %}
                                                        {% set date_part = log_file.split('_')[-1].replace('.log', '') %}
                                                        {{ date_part[:4] }}-{{ date_part[4:6] }}-{{ date_part[6:8] }}
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </small>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{{ url_for('view_log', filename=log_file) }}" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye me-1"></i>Ver
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                                            onclick="downloadLog('{{ log_file }}')">
                                                        <i class="fas fa-download me-1"></i>Download
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Informações sobre Logs
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p class="small">
                                        Os logs contêm informações detalhadas sobre:
                                    </p>
                                    <ul class="small">
                                        <li>Login das contas</li>
                                        <li>Seguidas realizadas</li>
                                        <li>Erros encontrados</li>
                                        <li>Estatísticas de uso</li>
                                    </ul>
                                    
                                    <div class="alert alert-warning alert-sm">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        <strong>Importante:</strong> Os logs podem conter informações sensíveis. 
                                        Mantenha-os seguros.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card border-warning mt-3">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-tools me-2"></i>
                                        Ações Rápidas
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="refreshLogs()">
                                            <i class="fas fa-sync me-2"></i>Atualizar Lista
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                                onclick="clearOldLogs()">
                                            <i class="fas fa-trash me-2"></i>Limpar Logs Antigos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-5x text-muted mb-3"></i>
                        <h4 class="text-muted">Nenhum log encontrado</h4>
                        <p class="text-muted">Os logs aparecerão aqui após executar a automação.</p>
                        <a href="{{ url_for('follow') }}" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>Executar Seguidas
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de Visualização de Log -->
<div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Visualizar Log
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="scrollToTop()">
                            <i class="fas fa-arrow-up me-1"></i>Topo
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="scrollToBottom()">
                            <i class="fas fa-arrow-down me-1"></i>Final
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="copyLogContent()">
                            <i class="fas fa-copy me-1"></i>Copiar
                        </button>
                    </div>
                </div>
                
                <div class="border rounded p-3" style="height: 500px; overflow-y: auto; background-color: #f8f9fa; font-family: monospace; font-size: 0.9rem;">
                    <pre id="logContent" class="mb-0"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function downloadLog(filename) {
        // Implementar download do log
        window.open(`/download_log/${filename}`, '_blank');
    }
    
    function refreshLogs() {
        location.reload();
    }
    
    function clearOldLogs() {
        if (confirm('Tem certeza que deseja limpar os logs antigos? Esta ação não pode ser desfeita.')) {
            // Implementar limpeza de logs antigos
            alert('Funcionalidade de limpeza será implementada em breve!');
        }
    }
    
    function scrollToTop() {
        const logContent = document.getElementById('logContent');
        logContent.scrollTop = 0;
    }
    
    function scrollToBottom() {
        const logContent = document.getElementById('logContent');
        logContent.scrollTop = logContent.scrollHeight;
    }
    
    function copyLogContent() {
        const logContent = document.getElementById('logContent');
        const text = logContent.textContent;
        
        navigator.clipboard.writeText(text).then(function() {
            alert('Conteúdo do log copiado para a área de transferência!');
        }, function(err) {
            console.error('Erro ao copiar: ', err);
            alert('Erro ao copiar o conteúdo do log.');
        });
    }
    
    // Auto-refresh a cada 30 segundos se houver logs
    {% if log_files %}
    setInterval(function() {
        // Verificar se há novos logs
        fetch('/api/logs/count')
            .then(response => response.json())
            .then(data => {
                if (data.count !== {{ log_files|length }}) {
                    location.reload();
                }
            })
            .catch(error => console.error('Erro ao verificar logs:', error));
    }, 30000);
    {% endif %}
</script>
{% endblock %}
